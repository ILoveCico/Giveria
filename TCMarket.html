<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GCMM v1.8.0 by Tralalero Tralala</title>
  <style>
    body { font-family: Arial; background:#f4f4f4; text-align:center; padding:20px }
    h1 { color:#333 }
    p { font-size:16px; color:#555; max-width:800px; margin:auto; text-align:left }
    textarea, input[type=text] {
      width:80%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px; font-size:16px
    }
    button {
      padding:10px 20px; font-size:16px;
      background:#28a745; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-bottom:10px
    }
    button:hover { background:#218838 }
    .copy-button {
      margin-left:5px; padding:4px 8px; font-size:13px;
      background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer
    }
    .copy-button:hover { background:#0056b3 }
    .table-container { margin-top:20px; display:flex; justify-content:center }
    table {
      border-collapse:collapse; width:90%;
      background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1)
    }
    th, td { border:1px solid #ddd; padding:8px; text-align:center }
    th { background:#007bff; color:#fff }
    .lowest-price    { background:#ffdd57 }  /* żółte */
    .best-unit-price { background:#90ee90 }  /* jasno-zielone */
  </style>
</head>
<body>

  <h1>Giveria Coin Market Manager v1.8.0</h1>
  <p>
    by Tralalero Tralala
    Wklej w tym polu listę aukcji w formacie:<br/>
    <code>[TC Market] #123: (by Sprzedawca) 10x Nazwa Przedmiotu [bonus1] [bonus2] ... - Price: 400 Tibia Coins</code><br/>
    Użyj filtrów, aby odsiać aukcje po nazwie i po bonusach.
  </p>

  <textarea id="dataInput" rows="6" placeholder="Wklej tu swoje aukcje..."></textarea><br/>
  <button id="processButton">Przetwórz dane</button><br/>
  <input id="filterInput" type="text" placeholder="Filtruj po nazwie przedmiotu..." oninput="renderTable()"/>
  <input id="bonusFilterInput" type="text" placeholder="Filtruj po bonusach..." oninput="renderTable()"/>

  <div class="table-container">
    <div id="output"></div>
  </div>

  <script>
    let prices = {};

    document.getElementById("processButton")
            .addEventListener("click", processData);

    function processData() {
      const raw = document.getElementById("dataInput").value.trim();
      const out = document.getElementById("output");
      if (!raw) {
        out.innerHTML = "<p>Brak danych wejściowych.</p>";
        return;
      }

      prices = {};
      raw.split("\n").forEach(line => {
        const txt = line.trim();
        if (!txt) return;

        // 1) Numer aukcji
        const idM = txt.match(/\[TC Market\]\s*#(\d+):/i);
        if (!idM) return;
        const id = idM[1];

        // 2) Wystawiający (opcjonalnie)
        const sellM = txt.match(/\(by\s*([^)]+)\)/i);
        const seller = sellM ? sellM[1].trim() : "";

        // 3) Ilość
        const qtyM = txt.match(/(\d+)x/i);
        if (!qtyM) return;
        const qty = parseInt(qtyM[1], 10);

        // 4) Cena całkowita
        const priceM = txt.match(/Price:\s*(\d+)\s*Tibia\s*Coins/i);
        if (!priceM) return;
        const total = parseInt(priceM[1], 10);

        // 5) Komenda i cena za sztukę
        const cmd  = `!market buy, ${id}`;
        const unit = Math.floor(total / qty);

        // 6) Wyciągamy część między "10x" a "- Price"
        const midStart = txt.indexOf(qtyM[0]) + qtyM[0].length;
        const midEnd   = txt.indexOf("- Price");
        let mid        = txt.slice(midStart, midEnd).trim();

        // 7) Z mid wydzielamy wszystkie bonusy
        const bonusMatches = [...mid.matchAll(/\[([^\]]+)\]/g)];
        const bonuses = bonusMatches.map(m => `[${m[1].trim()}]`).join(" ");

        // 8) Z mid usuwamy bonusy, zostaje nazwa
        const name = mid.replace(/\[.*?\]/g, "").trim();

        // 9) Zapis do struktury
        if (!prices[name]) prices[name] = [];
        prices[name].push({
          auction: "#" + id,
          seller,
          qty,
          bonus: bonuses,
          total,
          unit,
          cmd
        });
      });

      renderTable();
    }

    function renderTable() {
      const out    = document.getElementById("output");
      const fText  = document.getElementById("filterInput").value.toLowerCase();
      const bText  = document.getElementById("bonusFilterInput").value.toLowerCase();
      out.innerHTML = "";

      const items = Object.keys(prices).sort();
      if (!items.length) {
        out.innerHTML = "<p>Brak poprawnych danych.</p>";
        return;
      }

      const tbl = document.createElement("table");
      tbl.innerHTML = `
        <tr>
          <th>Numer aukcji</th>
          <th>Wystawiający</th>
          <th>Ilość</th>
          <th>Przedmiot</th>
          <th>Bonusy</th>
          <th>Cena (TC)</th>
          <th>Cena za sztukę (TC)</th>
          <th>Komenda</th>
        </tr>`;

      items.forEach(name => {
        const group    = prices[name];
        const minTotal = Math.min(...group.map(e => e.total));
        const minUnit  = Math.min(...group.map(e => e.unit));

        group.forEach(e => {
          // filtr po nazwie
          if (!name.toLowerCase().includes(fText)) return;
          // filtr po bonusach
          if (bText && !e.bonus.toLowerCase().includes(bText)) return;

          const row = document.createElement("tr");
          const vals = [
            e.auction,
            e.seller,
            e.qty + "x",
            name,
            e.bonus,
            e.total,
            e.unit,
            e.cmd
          ];

          vals.forEach((v,i) => {
            const td = document.createElement("td");
            td.textContent = v;
            if (i === 5 && e.total === minTotal) td.classList.add("lowest-price");
            if (i === 6 && e.unit  === minUnit)  td.classList.add("best-unit-price");
            row.appendChild(td);
          });

          // dodaj przycisk "Kopiuj"
          const btn = document.createElement("button");
          btn.className = "copy-button";
          btn.textContent = "Kopiuj";
          btn.onclick = () => {
            navigator.clipboard.writeText(e.cmd).then(() => {
              const old = btn.textContent;
              btn.textContent = "Skopiowano!";
              setTimeout(() => btn.textContent = old, 1500);
            });
          };
          row.cells[7].appendChild(document.createTextNode(" "));
          row.cells[7].appendChild(btn);

          tbl.appendChild(row);
        });
      });

      out.appendChild(tbl);
    }
  </script>
</body>
</html>
