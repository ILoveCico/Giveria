<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TC Market Prices v1.8.2</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #333; }
    p {
      font-size: 16px; color: #555;
      max-width: 800px; margin: auto; text-align: left;
    }
    textarea, input {
      width: 80%; padding: 10px; margin-top: 10px;
      border: 1px solid #ccc; border-radius: 5px;
      font-size: 16px;
    }
    button {
      margin-top: 10px; padding: 10px 20px;
      font-size: 16px; background-color: #28a745;
      color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background-color: #218838; }
    .table-container {
      margin-top: 20px; display: flex; justify-content: center;
    }
    table {
      border-collapse: collapse; width: 90%;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd; padding: 10px;
      text-align: center;
    }
    th {
      background-color: #007bff; color: white;
    }
    .lowest-price {
      background-color: #ffdd57;
    }
    .copy-button {
      margin-left: 5px; padding: 4px 8px;
      font-size: 13px; background-color: #007bff;
      color: white; border: none; border-radius: 4px;
      cursor: pointer;
    }
    .copy-button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h1>TC Market Prices v1.8.2</h1>
  <p>
    Ta tabela przedstawia aktualne ceny przedmiotów na TC Market.<br/>
    <strong>Jak odczytać?</strong>
    <ul>
      <li><strong>Numer aukcji:</strong> unikalny identyfikator (#123).</li>
      <li><strong>Wystawiający:</strong> osoba, która dodała aukcję (by X).</li>
      <li><strong>Ilość:</strong> liczba sztuk w paczce (np. 10x).</li>
      <li><strong>Przedmiot:</strong> nazwa przedmiotu.</li>
      <li><strong>Bonusy:</strong> np. [ml.+2%], lub pusta komórka.</li>
      <li><strong>Cena:</strong> łączny koszt w Tibia Coins (TC). Najniższa cena w kategorii podświetlona.</li>
      <li><strong>Cena za sztukę:</strong> koszt jednostkowy = Cena ÷ Ilość.</li>
      <li><strong>Komenda:</strong> !market buy, <numer aukcji> + przycisk "Kopiuj".</li>
    </ul>
  </p>

  <textarea id="dataInput" placeholder="Wklej listę aukcji TC Market..."></textarea><br/>
  <button id="processButton">Przetwórz dane</button><br/>
  <input id="filterInput" type="text" placeholder="Filtruj po nazwie przedmiotu..." oninput="renderTable()"/>
  <input id="bonusFilterInput" type="text" placeholder="Filtruj po bonusach..." oninput="renderTable()"/>

  <div class="table-container">
    <div id="output"></div>
  </div>

  <script>
    let prices = {};

    function processData() {
      const raw = document.getElementById("dataInput").value.trim();
      if (!raw) {
        document.getElementById("output").innerHTML = "<p>Brak danych wejściowych.</p>";
        return;
      }

      const lineRegex = /\[TC Market\]\s*#(\d+):\s*(?:\(by\s*([^)]+)\)\s*)?(\d+)x\s*(.+?)\s*-\s*Price:\s*(\d+)\s*Tibia\s*Coins/;
      prices = {};
      raw.split("\n").forEach(line => {
        const m = line.match(lineRegex);
        if (!m) return;
        const [, id, seller, qtyStr, rest, priceStr] = m;
        const auctionNumber = `#${id}`;
        const sellerName = seller || "";
        const quantity   = parseInt(qtyStr, 10);
        const price      = parseInt(priceStr, 10);
        let itemName     = rest;
        let bonuses      = "";
        const bIdx = rest.indexOf("[");
        if (bIdx !== -1) {
          itemName = rest.slice(0, bIdx).trim();
          bonuses  = rest.slice(bIdx).trim();
        }
        const unitPrice     = (price / quantity).toFixed(2);
        const marketCommand = `!market buy, ${id}`;

        if (!prices[itemName]) prices[itemName] = [];
        prices[itemName].push({
          auctionNumber,
          sellerName,
          quantity,
          bonuses,
          price,
          unitPrice,
          marketCommand
        });
      });

      renderTable();
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const old = button.textContent;
        button.textContent = "Skopiowano!";
        setTimeout(() => button.textContent = old, 2000);
      });
    }

    function renderTable() {
      const fText = document.getElementById("filterInput").value.toLowerCase();
      const bText = document.getElementById("bonusFilterInput").value.toLowerCase();
      const out   = document.getElementById("output");
      out.innerHTML = "";

      const items = Object.keys(prices).sort();
      if (!items.length) {
        out.innerHTML = "<p>Brak poprawnych danych.</p>";
        return;
      }

      const tbl = document.createElement("table");
      tbl.innerHTML = `
        <tr>
          <th>Numer aukcji</th>
          <th>Wystawiający</th>
          <th>Ilość</th>
          <th>Przedmiot</th>
          <th>Bonusy</th>
          <th>Cena (TC)</th>
          <th>Cena za sztukę (TC)</th>
          <th>Komenda</th>
        </tr>`;

      items.forEach(item => {
        const group = prices[item];
        const minPrice = Math.min(...group.map(x => x.price));
        group.forEach(entry => {
          if (
            item.toLowerCase().includes(fText) &&
            (bText === "" || entry.bonuses.toLowerCase().includes(bText))
          ) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${entry.auctionNumber}</td>
              <td>${entry.sellerName}</td>
              <td>${entry.quantity}x</td>
              <td>${item}</td>
              <td>${entry.bonuses}</td>
              <td ${entry.price === minPrice ? 'class="lowest-price"' : ""}>${entry.price}</td>
              <td>${entry.unitPrice}</td>
              <td>${entry.marketCommand}</td>
            `;
            // dodaj przycisk kopiowania
            const btnCell = row.cells[7];
            const btn = document.createElement("button");
            btn.className = "copy-button";
            btn.textContent = "Kopiuj";
            btn.onclick = () => copyToClipboard(entry.marketCommand, btn);
            btnCell.appendChild(btn);

            tbl.appendChild(row);
          }
        });
      });

      out.appendChild(tbl);
    }

    document.getElementById("processButton")
      .addEventListener("click", processData);
  </script>
</body>
</html>
```
